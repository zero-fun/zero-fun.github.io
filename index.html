<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>zeofuns - to be a better man</title><meta name="author" content="zerofuns"><meta name="copyright" content="zerofuns"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="当下即是彼岸">
<meta property="og:type" content="website">
<meta property="og:title" content="zeofuns">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="zeofuns">
<meta property="og:description" content="当下即是彼岸">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/cover/avatar.jpg">
<meta property="article:author" content="zerofuns">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/cover/avatar.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = { 
  isPost: false,
  isHome: true,
  isHighlightShrink: false,
  isToc: false,
  postUpdate: '2021-08-23 11:42:12'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><meta name="generator" content="Hexo 5.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/images/cover/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">36</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">5</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="page" id="body-wrap"><header class="full_page" id="page-header" style="background-image: url('/images/aerman.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">zeofuns</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="site-info"><h1 id="site-title">zeofuns</h1></div><div id="scroll-down"><i class="fas fa-angle-down scroll-down-effects"></i></div></header><main class="layout" id="content-inner"><div class="recent-posts" id="recent-posts"><div class="recent-post-item"><div class="recent-post-info no-cover"><a class="article-title" href="/2021/06/06/record/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%86%85%E5%AD%98%E6%BA%A2%E5%87%BA/" title="线程池内存溢出">线程池内存溢出</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2021-06-06T00:00:00.000Z" title="发表于 2021-06-06 08:00:00">2021-06-06</time></span><span class="article-meta"><span class="article-meta__separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/record/">record</a></span></div><div class="content">线程池内存溢出场景模拟处理 200万的数据，任务处理时间大概 2s
12345678910111213ExecutorService executorService = Executors.newFixedThreadPool(50);for (int i = 0; i &lt; 2000000; i++) &#123;  executorService.execute(() -&gt; &#123;    try &#123;      log.info(&quot;thread:&#123;&#125;,begin:&#123;&#125;&quot;, Thread.currentThread().getName());      TimeUnit.SECONDS.sleep(2);      log.info(&quot;thread:&#123;&#125;,begin:&#123;&#125;&quot;, Thread.currentThread().getName());    &#125; catch (InterruptedException e) &#123;   ...</div></div></div><div class="recent-post-item"><div class="recent-post-info no-cover"><a class="article-title" href="/2021/06/02/redis/Redis%E5%BA%95%E5%B1%82%E5%AD%A6%E4%B9%A0-Sentinel%E5%AE%9E%E7%8E%B0%E9%AB%98%E5%8F%AF%E7%94%A8/" title="Redis底层学习-Sentinel实现高可用">Redis底层学习-Sentinel实现高可用</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2021-06-02T00:00:00.000Z" title="发表于 2021-06-02 08:00:00">2021-06-02</time></span><span class="article-meta"><span class="article-meta__separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Redis/">Redis</a></span></div><div class="content">Sentinel 实现高可用Sentinel 是 Redis 的高可用性解决方案：有一个或多个 Sentinel 实例组成的 Sentinel 系统可以检测多个主服务器，以及这些主服务器属下的所有从服务器，并在被监视的主服务器进入下线状态时，自己将下线主服务器属下的某个从服务器升级为新的主服务器，然后由新的主服务器代替已下线的主服务器继续处理命令请求。
特点：动态感知上下线，动态切换主服务器。
Sentinel 本质上只是一个运行在特殊模式下的 Redis 服务器，执行的工作和普通 Redis 服务器不同。
Sentinel 实现高可用的流程
sentinel 集群通过配置文件发现 matser，启动时会监控 master。
向 master 发送 info 命令，获取所有 slave 节点。
sentinel 集群向 Redis 主从服务器发送 hello 信息(心跳)，包括 sentinel 本身的 IP、端口、id 等内容，以此来向其他 sentinel 宣告自己的存在。
sentinel 集群通过订阅接受其他 sentinel 发送的 hello 信息，以此来发现监控同一个主服 ...</div></div></div><div class="recent-post-item"><div class="recent-post-info no-cover"><a class="article-title" href="/2021/05/29/redis/Redis%E5%BA%95%E5%B1%82%E5%AD%A6%E4%B9%A0-%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9B%B8%E5%85%B3/" title="Redis底层学习-数据库相关">Redis底层学习-数据库相关</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2021-05-29T00:00:00.000Z" title="发表于 2021-05-29 08:00:00">2021-05-29</time></span><span class="article-meta"><span class="article-meta__separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Redis/">Redis</a></span></div><div class="content">Redis 底层学习-数据库数据库结构
数据库结构，redisServer 中有一个 redisDb 对象数组，对应 redis 中的不同数据库，dbnum 记录了数据库在初始化的时候初始数据库个数。

上面是 redisDb 的数据结构，redisDb 中有 2 个字典，一个字典 dict 为真正保存数据的地方，键为 redis 数据的 key，值为具体的数据类型，通过指针指向不同数据库。expires 字典中存储了每个键对应的失效时间，每次在获取对应键的时候会先判断 expire 字典对应的失效时间是否小于当前时间，如果到期的话，就直接删除对应的键值对。
Redis 的过期删除策略
惰性删除策略：Redis 在所有读写操作之前都会调用 expireIfNeeded 对输入键进行检查，如果输入键已经过期，会将对应的输入键从服务器中删除。
定期删除策略：Redis 在周期性 servercron 函数执行时，activeExpireCycle 函数就会被调用。它会在规定的时间内，分多次遍历服务器中的多个数据库，从数据库中字典中随机检查一部分键的过期时间，并删除其中的过期键。

AOF、 ...</div></div></div><div class="recent-post-item"><div class="recent-post-info no-cover"><a class="article-title" href="/2021/05/14/record/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%85%A8%E7%9B%98%E6%89%AB%E6%8F%8F%E5%AF%BC%E8%87%B4%E7%9A%84%E5%86%85%E5%AD%98%E6%BA%A2%E5%87%BA/" title="数据库全盘扫描导致的内存溢出">数据库全盘扫描导致的内存溢出</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2021-05-14T00:00:00.000Z" title="发表于 2021-05-14 08:00:00">2021-05-14</time></span><span class="article-meta"><span class="article-meta__separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/record/">record</a></span></div><div class="content">数据库全盘扫描导致的内存溢出情景同步 10万的数据到内容库，总是在执行 10多分钟之后突然出现 OutOfMemoryError。
1Exception in thread &quot;pool-1-thread-38&quot; java.lang.OutOfMemoryError: Java heap space# 

探索之前一直以为是线程池的原因，所以调整了线程池的大小
12345678910executorService = new ThreadPoolExecutor(20, 50,        60l, TimeUnit.MINUTES, new ArrayBlockingQueue(1000), (r, executor) -&gt; &#123;      if (!executor.isShutdown()) &#123;        try &#123;          executor.getQueue().put(r);        &#125; catch (InterruptedException e) &#123;          Thread ...</div></div></div><div class="recent-post-item"><div class="recent-post-info no-cover"><a class="article-title" href="/2021/05/14/redis/Redis%E5%BA%95%E5%B1%82%E5%AD%A6%E4%B9%A0-%E5%A4%9A%E6%9C%BA%E6%95%B0%E6%8D%AE%E5%BA%93/" title="Redis底层学习-多机数据库">Redis底层学习-多机数据库</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2021-05-14T00:00:00.000Z" title="发表于 2021-05-14 08:00:00">2021-05-14</time></span><span class="article-meta"><span class="article-meta__separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Redis/">Redis</a></span></div><div class="content">Redis 底层学习-多机数据库复制旧版复制Redis 的复制功能分为同步和命令传播两个操作：

同步操作作用于将从服务器的数据库状态更新至主服务器当前所处的数据库状态
命令传播操作则用于在主服务器的数据库状态被修改，导致主从服务器的数据库状态出现不一致的时候，让主从服务器的数据库重新回到一致状态

同步
当客户端向从服务器发送 slaveeof 命令，要求从服务器复制主服务器是，从服务器先执行同步操作。
从服务器对主服务器的同步操作需要通过向主服务器发送 sync 命令来完成，以下是 sync 命令的执行步骤：

从服务器向主服务器发送 sync 命令。

收到 sync 命令的主服务器执行 bgsave 命令，在后台生成一个 RDB 文件，并使用一个缓冲区记录从现在开始执行的所有写命令

当主服务器的 bgsave 命令执行完毕时，主服务器会将 bgsave 命令生成的 rdb 文件发送到服务器，从服务器接受并载入这个 RDB 文件，将自己的数据库状态更新至主服务器执行 bgsave 命令时的数据库状态。

主服务器将记录在缓冲区里面的所有写命令发送给从服务器，从服务器执行这些写命 ...</div></div></div><div class="recent-post-item"><div class="recent-post-info no-cover"><a class="article-title" href="/2021/04/27/redis/Redis%E5%BA%95%E5%B1%82%E5%AD%A6%E4%B9%A0-%E4%BA%8B%E5%8A%A1/" title="Redis底层学习-事务">Redis底层学习-事务</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2021-04-27T00:00:00.000Z" title="发表于 2021-04-27 08:00:00">2021-04-27</time></span><span class="article-meta"><span class="article-meta__separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Redis/">Redis</a></span></div><div class="content">Redis 底层学习-事务Redis 通过 multi、exec、watch 等命令来实现事务功能。事务提供了一种将多个命令请求打包，然后一次性、按顺序地执行多个命令的机制，并且在事务执行期间，服务器不会中断事务而改去执行其他客户端的命令请求 ，它会将事务中的所有命令都执行完毕，然后才去处理其他客户端的命令请求。
eg:

事务的实现一个事务从开始到结束通常会经历以下三个阶段

事务开始
命令入队
事务执行

事务开始multi 命令的执行标志着事务的开始
multi 命令可以将执行该命令的客户端从非事务状态切换至事务状态，这一切换是通过客户端的 flags 属性中打开 redis_multi 标识来实现的。
命令入队当一个客户端处于非事务状态时，这个客户端发送的命令会立即被服务器执行。
与此不同的是，放一个客户端切换到事务状态之后，服务器会根据这个客户端发来的不同命令执行不同的操作。

如果客户端发送的命令为 exec、discard、watch、multi 四个命令的其中一个，那么服务器会立即执行这个命令。
与此相反，如果客户端发送的是上述 4 个命令之外的其他命令，那么服务器并不 ...</div></div></div><div class="recent-post-item"><div class="recent-post-info no-cover"><a class="article-title" href="/2021/04/16/redis/Redis%E5%BA%95%E5%B1%82%E5%AD%A6%E4%B9%A0-%E9%9B%86%E7%BE%A4%E6%A8%A1%E5%BC%8F/" title="Redis底层学习-集群模式">Redis底层学习-集群模式</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2021-04-16T00:00:00.000Z" title="发表于 2021-04-16 08:00:00">2021-04-16</time></span><span class="article-meta"><span class="article-meta__separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Redis/">Redis</a></span></div><div class="content">Redis 底层学习-集群模式Redis 集群是 Redis 提供的分布式数据库方案，集群通过分片来进行数据共享，并提供复制和故障转移功能。
节点一个 Redis 集群通常由多个节点组成，在开始的时候，每个节点都是相互独立的，它们都处于一个只包含自己的集群中，要组建一个真正可用的集群，我们必须将各个独立的节点连接起来，构建一个包含多个节点的集群。
每个节点都保存着 clusterState 结构，这个结构记录了在当前节点的视角下，集群目前所处的状态。

其中 clusterNode 节点保存的是节点对应配置消息和状态

添加节点到集群通过 cluster meet 命令添加节点到集群。
cluster meet 命令的实现通过向节点 A 发送 cluster meet 命令，客户端可以让接收命令的节点 A 将另一个节点 B 添加到节点 A 当前所在的集群中
收到命令的节点 A 将于节点 B 进行握手，以此来确认彼此的存在，并为将来进一步的通信打好基础

节点 A 会为节点 B 创建一个 clusterNode 结构，并将该结构添加到自己的 clusterState.node 字典里面
 ...</div></div></div><div class="recent-post-item"><div class="recent-post-info no-cover"><a class="article-title" href="/2021/03/17/record/%E7%BA%BF%E4%B8%8A%20CPU%20%E7%88%86%E6%BB%A1%E5%A6%82%E4%BD%95%E6%8E%92%E6%9F%A5/" title="线上 CPU 爆满如何排查">线上 CPU 爆满如何排查</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2021-03-17T00:00:00.000Z" title="发表于 2021-03-17 08:00:00">2021-03-17</time></span><span class="article-meta"><span class="article-meta__separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/record/">record</a></span></div><div class="content">线上 CPU 爆满如何排查模拟代码123456789101112131415161718192021222324252627282930313233343536373839404142public class ThreadDemo &#123;  static Map&lt;String, String&gt; map = new HashMap&lt;&gt;();  public static class AddThread implements Runnable &#123;    int start = 0;    public AddThread(int start) &#123;      this.start = start;    &#125;    @Override    public void run() &#123;      //死循环,模拟CPU占用过高场景      while (true) &#123;        for (int i = start; i &lt; 100000; i += 4) &#123;          map.put(In ...</div></div></div><div class="recent-post-item"><div class="recent-post-info no-cover"><a class="article-title" href="/2021/03/17/redis/Redis%E5%BA%95%E5%B1%82%E5%AD%A6%E4%B9%A0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" title="Redis底层学习-数据结构">Redis底层学习-数据结构</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2021-03-17T00:00:00.000Z" title="发表于 2021-03-17 08:00:00">2021-03-17</time></span><span class="article-meta"><span class="article-meta__separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Redis/">Redis</a></span></div><div class="content">Redis 底层学习-数据结构1.简单动态字符串-SDS数据结构

len: 记录 sds 字符串的长度
free：buf 数组中未使用的数量
buf[]:保存字符串的字节数组

需要注意的是，buf 数组中最后一个字节存储的是\0，并且这个字节并不计算到 len 的长度中。这么做的原因是为了保持和 c 语言中的字符串保持一致，可以直接使用 c 语言字符串的一些库函数。
SDS 和 c 语言字符串的区别常数复杂度获取字符串长度
SDS 包含了 len 属性，可以在 O(1)的复杂度中获取到字符串长度，而 c 语言需要便利整个字符串，直到字符串结尾计数结束，复杂度为 O(n)
杜绝缓冲区溢出
在 c 语言字符串中，在执行 strcat 函数，假定当前字符串分配了足够的内存。如果当前字符串的分配长度不够修改的长度，那么会顺延到下一个空间，会造成当前字符串修改错误，下一个空间的变量也会被莫名修改。
在 sds 字符串中，修改的时候会判断 len 的长度是否满足需要，否则进行扩容
减少内存重分配的次数
c 语言字符串在执行 append、trim 函数的时候，需要通过内存重分配来扩展空间或者释 ...</div></div></div><div class="recent-post-item"><div class="recent-post-info no-cover"><a class="article-title" href="/2021/03/08/redis/Redis%E5%BA%95%E5%B1%82%E5%AD%A6%E4%B9%A0-%E5%AF%B9%E8%B1%A1/" title="Redis底层学习-对象">Redis底层学习-对象</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2021-03-08T00:00:00.000Z" title="发表于 2021-03-08 08:00:00">2021-03-08</time></span><span class="article-meta"><span class="article-meta__separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Redis/">Redis</a></span></div><div class="content">Redis 底层学习-对象redis 中的对象就是我们常说的 redis 数据类型，字符串对象、列表对象、哈希对象、集合对象、有序集合对象这 5 种数据类型。
这 5 种数据类型在实际使用的时候使用了上一章中的 2 种以上的数据结构，来满足不同场景下的使用效率。
在我们创建一个键值对的时候。实际上创建了 2 个对象，一个为键的字符串对象，一个为值的具体对象。
数据结构
type：对象的类型，只能是 5 种数据类型的一种。可以通过命令type key获取对象的类型

encoding：编码，记录了对象使用什么数据结构来作为对象的底层实现。可以通过object encoding key来获取对象的编码。


字符串对象字符串对象的编码可以是 int、raw、embstr。

如果一个字符串对象保存的是整数值，并且这个整数值可以用 long 类型来表示，那么字符串对象会将整数值保存在字符串对象结构的 ptr 属性里面(将 void*转换成 long)，并将字符串对象的编码设置为 int。


ptr 指针变成存放具体指的对象。

如果字符串对象保存的是一个字符串值，并且这个字符值的长度大于  ...</div></div></div><nav id="pagination"><div class="pagination"><span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fas fa-chevron-right fa-fw"></i></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="/images/cover/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">zerofuns</div><div class="author-info__description">当下即是彼岸</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">36</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">5</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/zero-fun"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">起风了</div></div><div class="sticky_layout"><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2021/06/06/record/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%86%85%E5%AD%98%E6%BA%A2%E5%87%BA/" title="线程池内存溢出">线程池内存溢出</a><time datetime="2021-06-06T00:00:00.000Z" title="发表于 2021-06-06 08:00:00">2021-06-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2021/06/02/redis/Redis%E5%BA%95%E5%B1%82%E5%AD%A6%E4%B9%A0-Sentinel%E5%AE%9E%E7%8E%B0%E9%AB%98%E5%8F%AF%E7%94%A8/" title="Redis底层学习-Sentinel实现高可用">Redis底层学习-Sentinel实现高可用</a><time datetime="2021-06-02T00:00:00.000Z" title="发表于 2021-06-02 08:00:00">2021-06-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2021/05/29/redis/Redis%E5%BA%95%E5%B1%82%E5%AD%A6%E4%B9%A0-%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9B%B8%E5%85%B3/" title="Redis底层学习-数据库相关">Redis底层学习-数据库相关</a><time datetime="2021-05-29T00:00:00.000Z" title="发表于 2021-05-29 08:00:00">2021-05-29</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2021/05/14/record/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%85%A8%E7%9B%98%E6%89%AB%E6%8F%8F%E5%AF%BC%E8%87%B4%E7%9A%84%E5%86%85%E5%AD%98%E6%BA%A2%E5%87%BA/" title="数据库全盘扫描导致的内存溢出">数据库全盘扫描导致的内存溢出</a><time datetime="2021-05-14T00:00:00.000Z" title="发表于 2021-05-14 08:00:00">2021-05-14</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2021/05/14/redis/Redis%E5%BA%95%E5%B1%82%E5%AD%A6%E4%B9%A0-%E5%A4%9A%E6%9C%BA%E6%95%B0%E6%8D%AE%E5%BA%93/" title="Redis底层学习-多机数据库">Redis底层学习-多机数据库</a><time datetime="2021-05-14T00:00:00.000Z" title="发表于 2021-05-14 08:00:00">2021-05-14</time></div></div></div></div><div class="card-widget card-categories"><div class="item-headline">
            <i class="fas fa-folder-open"></i>
            <span>分类</span>
            
            </div>
            <ul class="card-category-list" id="aside-cat-list">
            <li class="card-category-list-item "><a class="card-category-list-link" href="/categories/JDK/"><span class="card-category-list-name">JDK</span><span class="card-category-list-count">2</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/Mybaties/"><span class="card-category-list-name">Mybaties</span><span class="card-category-list-count">2</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/Redis/"><span class="card-category-list-name">Redis</span><span class="card-category-list-count">7</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/Spring/"><span class="card-category-list-name">Spring</span><span class="card-category-list-count">4</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/SpringBoot/"><span class="card-category-list-name">SpringBoot</span><span class="card-category-list-count">4</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/SpringCloud/"><span class="card-category-list-name">SpringCloud</span><span class="card-category-list-count">5</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/record/"><span class="card-category-list-name">record</span><span class="card-category-list-count">5</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"><span class="card-category-list-name">多线程</span><span class="card-category-list-count">6</span></a></li>
            </ul></div><div class="card-widget card-tags"><div class="item-headline"><i class="fas fa-tags"></i><span>标签</span></div><div class="card-tag-cloud"><a href="/tags/CopyOnWriteArrayList/" style="font-size: 1.1em; color: #999">CopyOnWriteArrayList</a> <a href="/tags/List/" style="font-size: 1.1em; color: #999">List</a> <a href="/tags/Vector/" style="font-size: 1.1em; color: #999">Vector</a> <a href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" style="font-size: 1.5em; color: #99a9bf">源码分析</a> <a href="/tags/%E9%9B%86%E5%90%88/" style="font-size: 1.5em; color: #99a9bf">集合</a></div></div><div class="card-widget card-archives"><div class="item-headline"><i class="fas fa-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="fas fa-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2021/06/"><span class="card-archive-list-date">六月 2021</span><span class="card-archive-list-count">2</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2021/05/"><span class="card-archive-list-date">五月 2021</span><span class="card-archive-list-count">3</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2021/04/"><span class="card-archive-list-date">四月 2021</span><span class="card-archive-list-count">2</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2021/03/"><span class="card-archive-list-date">三月 2021</span><span class="card-archive-list-count">3</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2021/02/"><span class="card-archive-list-date">二月 2021</span><span class="card-archive-list-count">1</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2021/01/"><span class="card-archive-list-date">一月 2021</span><span class="card-archive-list-count">1</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2020/10/"><span class="card-archive-list-date">十月 2020</span><span class="card-archive-list-count">4</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2020/09/"><span class="card-archive-list-date">九月 2020</span><span class="card-archive-list-count">2</span></a></li></ul></div><div class="card-widget card-webinfo"><div class="item-headline"><i class="fas fa-chart-line"></i><span>网站资讯</span></div><div class="webinfo"><div class="webinfo-item"><div class="item-name">文章数目 :</div><div class="item-count">36</div></div><div class="webinfo-item"><div class="item-name">本站访客数 :</div><div class="item-count" id="busuanzi_value_site_uv"></div></div><div class="webinfo-item"><div class="item-name">本站总访问量 :</div><div class="item-count" id="busuanzi_value_site_pv"></div></div><div class="webinfo-item"><div class="item-name">最后更新时间 :</div><div class="item-count" id="last-push-date" data-lastPushDate="2021-08-23T03:42:12.567Z"></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By zerofuns</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>